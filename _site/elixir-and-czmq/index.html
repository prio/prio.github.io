<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Elixir and ZeroMQ</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Just my thoughts, right or wrong" />
    <link rel="shortcut icon" href="http://localhost:5657/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="http://localhost:5657/elixir-and-czmq/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Jonathan Harrington" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Elixir and ZeroMQ" />
    <meta property="og:description" content="Just my thoughts, right or wrong" />
    <meta property="og:url" content="http://localhost:5657/elixir-and-czmq/" />
    <meta property="og:image" content="http://localhost:5657/images/pair.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Elixir and ZeroMQ" />
    <meta name="twitter:description" content="Just my thoughts, right or wrong" />
    <meta name="twitter:url" content="http://localhost:5657/" />
    <meta name="twitter:image" content="http://localhost:5657/images/pair.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jonathan Harrington" />
    <meta name="twitter:site" content="@jonathanharring" />
    <meta name="twitter:creator" content="@jonathanharring" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="666" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Jonathan Harrington",
        "logo": "http://localhost:5657/"
    },
    "url": "http://localhost:5657/elixir-and-czmq/",
    "image": {
        "@type": "ImageObject",
        "url": "http://localhost:5657/images/pair.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:5657/elixir-and-czmq/"
    },
    "description": "Just my thoughts, right or wrong"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Elixir and ZeroMQ" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="http://localhost:5657/">Jonathan Harrington</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-tgh" href="https://github.com/prio" target="_blank" rel="noopener"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
            
            
                <a class="social-link social-link-tli" href="https://www.linkedin.com/in/jnharrington" target="_blank" rel="noopener"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn icon</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
                                    
            
                <a class="social-link social-link-tw" href="https://twitter.com/jonathanharring" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  post ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="31 July 2015">31 July 2015</time>
                    
                </section>
                <h1 class="post-full-title">Elixir and ZeroMQ</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/images/pair.jpg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>ZeroMQ is an excellent, language agnostic messaging and concurrency library. It can be used to provide non-BEAM based languages with some (but not all!) of the features that we take for granted when writing code in Elixir on the erlang vm. For this post, we will focus on its capabilities as a messaging library. This post gives a brief overview of ZeroMQ but you really should read the excellent <a href="http://zguide.zeromq.org/page:all">ZeroMQ guide</a> to gain a more complete understanding.
<!--excerpt--></p>

<h2 id="sockets">Sockets</h2>

<p>If you have done any socket programming in the past, you will know what a painful process it is to create reliable, scalable programs using them as your base abstraction. And that pain only intensifies if you need to build more sophisticated network topologies. At that point most people give up and reach for sophisticated protocols such as AMQP and intermediary services such as RabbitMQ. RabbitMQ is great, and if it suits your use case you should use it, but sometimes you just don’‘t want or need the overhead of AMQP and maintaining an install of a third party service. It’’s at times like these you should consider ZeroMQ.</p>

<h2 id="topologies">Topologies</h2>

<p>ZeroMQ offers a number of different topologies or messaging patterns out of the box. We will describe fours of these briefly in this post. Put first the basics.</p>

<p>The two fundamental ZeroMQ building blocks are the context and socket structures. A context is threadsafe and is used to store the state required by a socket. An application can have multiple contexts. You don’‘t need to worry about them for these examples, just be aware of their existence.</p>

<p>A socket is used for communication and is given a certain <em>type</em> at creation time. It’’s these types that allow us to build different topologies.</p>

<p>The high level process when writing ZeroMQ code is:</p>

<ol>
  <li>Create a context</li>
  <li>Use that context to create a socket of a certain type</li>
  <li>Either bind (if the process is a server) or connect (if the process is a client) using that socket</li>
</ol>

<p>You are then ready to send and receive messages using the <em>zstr_send</em> and <em>zstr_recv</em> functions.</p>

<h3 id="setup">Setup</h3>

<p><strong>Note:</strong> There are a number of different ZeroMQ wrappers available for Erlang but we are going to use <a href="https://github.com/gar1t/erlang-czmq">erlang-czmq</a> as it seems to be one of the most actively maintained and stable. The concepts are the same no matter what library you use.</p>

<p>The examples that follow are all simple enough to be run in an iex sessions. Create a new mix project and add czmq to your deps.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir">  <span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
    <span class="p">[{</span><span class="ss">:czmq</span><span class="p">,</span> <span class="ss">github:</span> <span class="sd">"</span><span class="s2">gar1t/erlang-czmq"</span><span class="p">,</span> <span class="ss">compile:</span> <span class="sd">"</span><span class="s2">./configure; make"</span><span class="p">}]</span>
  <span class="k">end</span></code></pre></figure>

<p>As czmq is an erlang library we need to add one more file to help with interop. Create a src directory, and add the <a href="https://gist.github.com/prio/0d345da03ffc8af71476">czmq_const.erl file</a> I created.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir src
$ cd src
$ curl -O https://gist.githubusercontent.com/prio/0d345da03ffc8af71476/raw/b937225fbad15253936caa9c42e0e8dfab3b11ed/czmq_const.erl
</code></pre></div></div>

<h3 id="pair">Pair</h3>
<p>The simplest messaging pattern is the <strong>PAIR</strong> pattern. Of all the patterns available its behaviour is that one that most closely matches traditional sockets. The server listens on a port and a client connects to that port. Server and client are then able to send messages to each other. Only one client can connect to the port at one time.</p>

<p><img src="/images/pair.jpg" alt="Pair Pattern" /></p>

<p><strong>Server session</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iex(1)&gt; {:ok, ctx} = :czmq.start_link()
iex(2)&gt; socket = :czmq.zsocket_new(ctx, :czmq_const.zmq_pair)
iex(3)&gt; {:ok, port} = :czmq.zsocket_bind(socket, "tcp://*:5555")
iex(4)&gt; :ok = :czmq.zstr_send(socket, "Hello, client")
iex(5)&gt; {:ok, msg} = :czmq.zstr_recv(socket, [{:timeout, 1000}])
{:ok, ''Hello, server''}
</code></pre></div></div>

<p><strong>Client session</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iex(1)&gt; {:ok, ctx} = :czmq.start_link()
iex(2)&gt; socket = :czmq.zsocket_new(ctx, :czmq_const.zmq_pair)
iex(3)&gt; :ok = :czmq.zsocket_connect(socket, "tcp://localhost:5555")
iex(4)&gt; :czmq.zstr_recv(socket, [{:timeout, 1000}])
{:ok, ''Hello, client''}
iex(5)&gt; :ok = :czmq.zstr_send(socket, "Hello, server")
</code></pre></div></div>

<p>Now that you have seen how simple it is to setup basic two way communication lets take a look at some of the other messaging patterns.</p>

<h3 id="client--server">Client / Server</h3>

<p>This is probably the pattern the majority of us are most familiar with. We have one server process that is communicating with multiple clients. The server socket type is <strong>zmq_rep</strong> (reply) and the client socket type is <strong>zmq_req</strong> (request).</p>

<p><img src="/images/repreq.jpg" alt="" /></p>

<p><strong>Server session</strong></p>

<p>Lets create a basic echo server. Type the following into an iex session.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">echo</span> <span class="o">=</span> <span class="k">fn</span><span class="p">(</span><span class="n">echo</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">msg</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zstr_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
  <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="ss">:ok</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zstr_send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
  <span class="n">echo</span><span class="o">.</span><span class="p">(</span><span class="n">echo</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
<span class="k">end</span>

<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">ctx</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="ss">:czmq_const</span><span class="o">.</span><span class="n">zmq_rep</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">port</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_bind</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">tcp://*:5555"</span><span class="p">)</span>
<span class="n">echo</span><span class="o">.</span><span class="p">(</span><span class="n">echo</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span></code></pre></figure>

<p>Now, open one or more iex sessions and start sending requests</p>

<p><strong>Client session</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{:ok, ctx} = :czmq.start_link()
socket = :czmq.zsocket_new(ctx, :czmq_const.zmq_req)
:ok = :czmq.zsocket_connect(socket, "tcp://localhost:5555")
:czmq.zstr_send(socket, "echo")
:czmq.zstr_recv(socket)
:czmq.zstr_send(socket, "hello")
:czmq.zstr_recv(socket)
</code></pre></div></div>

<p>Notice how easy it is to set up a server that can handle multiple clients. ZeroMQ automatically handles all the book keeping involved in tracking each client and only sends the response to the correct client.</p>

<h3 id="publishsubscribe">Publish/Subscribe</h3>

<p>In the past when I have required pubsub functionality I have always reached for a dedicated broker such as RabbitMQ, but ZeroMQ allows us to easily create pubsub topologies without the need for a third party broker. The server (publisher/broker) socket type is <strong>zmq_pub</strong> and the client (subscriber/consumer) type is <strong>zmq_sub</strong>. A publisher can have multiple subscribers, and a subscriber can subscribe to multiple publishers.</p>

<p><img src="/images/pubsub.jpg" alt="" /></p>

<p><strong>Server session</strong></p>

<p>Our server will publish messages (an integer) over one of 4 topics a,b,c or d every second. Subscribers can subscribe to one or more topics of interest.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">ctx</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="ss">:czmq_const</span><span class="o">.</span><span class="n">zmq_pub</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">port</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_bind</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">tcp://*:5555"</span><span class="p">)</span>
<span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="sd">"</span><span class="s2">_"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">a"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">b"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">c"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">d"</span><span class="p">]</span>
<span class="no">Stream</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="m">1_000</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
  <span class="n">topic</span> <span class="o">=</span> <span class="no">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">topics</span><span class="p">,</span> <span class="ss">:random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="m">4</span><span class="p">))</span>
  <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="sd">"</span><span class="s2">Sending </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">topic</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="ss">:czmq</span><span class="o">.</span><span class="n">zstr_send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="si">#{</span><span class="n">topic</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span></code></pre></figure>

<p><strong>Client session</strong></p>

<p>Again, feel free to start up more than one client and have different clients subscribe to the same and different topics.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">sub</span> <span class="o">=</span> <span class="k">fn</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">msg</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zstr_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
  <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="n">sub</span><span class="o">.</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
<span class="k">end</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">ctx</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="ss">:czmq_const</span><span class="o">.</span><span class="n">zmq_sub</span><span class="p">)</span>
<span class="ss">:ok</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_connect</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">tcp://localhost:5555"</span><span class="p">)</span>
<span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_set_subscribe</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">a"</span> <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">to_char_list</span><span class="p">)</span>
<span class="n">sub</span><span class="o">.</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span></code></pre></figure>

<h3 id="pushpull">Push/Pull</h3>

<p>The final pattern I will cover is the “Parallel Pipeline” using push/pull socket types. This pattern enables us to push “work” from a ventilator/producer to multiple workers who in turn push their “result” to a sink/collector.</p>

<p>This example creates a producer that creates a “task” with an integer payload, a group of workers that keep a running total of these integers, and a sink that prints these running totals to the console.</p>

<p><img src="/images/pushpull.jpg" alt="" /></p>

<p><strong>Producer session</strong></p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">ctx</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="ss">:czmq_const</span><span class="o">.</span><span class="n">zmq_push</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">port</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_bind</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">tcp://*:5555"</span><span class="p">)</span>
<span class="no">Stream</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="m">1_000</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
  <span class="ss">:czmq</span><span class="o">.</span><span class="n">zstr_send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span></code></pre></figure>

<p><strong>Worker session</strong></p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">work</span> <span class="o">=</span> <span class="k">fn</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">recv_socket</span><span class="p">,</span> <span class="n">send_socket</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">raw</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zstr_recv</span><span class="p">(</span><span class="n">recv_socket</span><span class="p">)</span>
  <span class="p">{</span><span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="no">Integer</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">to_string</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
  <span class="n">total</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">x</span>
  <span class="ss">:czmq</span><span class="o">.</span><span class="n">zstr_send</span><span class="p">(</span><span class="n">send_socket</span><span class="p">,</span> <span class="sd">"</span><span class="si">#{</span><span class="n">total</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="n">work</span><span class="o">.</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">recv_socket</span><span class="p">,</span> <span class="n">send_socket</span><span class="p">)</span>
<span class="k">end</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">ctx</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
<span class="n">recv_socket</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="ss">:czmq_const</span><span class="o">.</span><span class="n">zmq_pull</span><span class="p">)</span>
<span class="ss">:ok</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_connect</span><span class="p">(</span><span class="n">recv_socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">tcp://localhost:5555"</span><span class="p">)</span>
<span class="n">send_socket</span>  <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="ss">:czmq_const</span><span class="o">.</span><span class="n">zmq_push</span><span class="p">)</span>
<span class="ss">:ok</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_connect</span><span class="p">(</span><span class="n">send_socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">tcp://localhost:5556"</span><span class="p">)</span>
<span class="n">work</span><span class="o">.</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">recv_socket</span><span class="p">,</span> <span class="n">send_socket</span><span class="p">)</span></code></pre></figure>

<p><strong>Collector session</strong></p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">collect</span> <span class="o">=</span> <span class="k">fn</span><span class="p">(</span><span class="n">collect</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">x</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zstr_recv</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
  <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="sd">"</span><span class="s2">Total is </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="n">collect</span><span class="o">.</span><span class="p">(</span><span class="n">collect</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
<span class="k">end</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">ctx</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_new</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="ss">:czmq_const</span><span class="o">.</span><span class="n">zmq_pull</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">port</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:czmq</span><span class="o">.</span><span class="n">zsocket_bind</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">tcp://*:5556"</span><span class="p">)</span>
<span class="n">collect</span><span class="o">.</span><span class="p">(</span><span class="n">collect</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span></code></pre></figure>

<p>Notice, that in each session we have to be careful to send strings over the socket and unpack them in the receiver if required. The czmq library does not support sending erlang values such as ints over sockets.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I hope this helps to get you up and running using ZeroMQ with Elixir. The examples I have shown here are just from the <strong>first</strong> chapter of the the ZeroMQ guide.</p>

<p>If you are familiar with another programming language try porting one or two of the client examples to it and connect them up to your Elixir server processes.</p>

<p>There really is so much more to ZeroMQ than what I have covered above so please dig into the documentation yourself and learn more about what this excellent library is capable of.</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'http://localhost:5657/elixir-and-czmq/';
                            this.page.identifier = '/elixir-and-czmq';
                            this.page.title = 'Elixir and ZeroMQ';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://magpietech.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>


<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'true';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/custom-query-language/">
                <div class="post-card-image" style="background-image: url(/images/query.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/custom-query-language/">
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">A Custom Query Language</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/elixir-and-docker/">
                <div class="post-card-image" style="background-image: url(/images/docker.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/elixir-and-docker/">
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Elixir, Docker and PG2</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="http://localhost:5657/">
            
                <img src="/assets/images/favicon.png" alt="Jonathan Harrington icon" />
            
            <span>Jonathan Harrington</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Elixir and ZeroMQ</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Elixir+and+ZeroMQ&amp;url=https://blog.jonharrington.org/elixir-and-czmq/"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.jonharrington.org/elixir-and-czmq/"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="http://localhost:5657/">Jonathan Harrington</a> &copy; 2020</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    <a href="https://github.com/prio" target="_blank" rel="noopener">Github</a>
                    <a href="https://www.linkedin.com/in/jnharrington" target="_blank" rel="noopener">Linkedin</a>
                    <a href="https://twitter.com/jonathanharring" target="_blank" rel="noopener">Twitter</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
