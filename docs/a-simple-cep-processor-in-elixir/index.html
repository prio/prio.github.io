<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>A CEP Processor in Elixir</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Just my thoughts, right or wrong" />
    <link rel="shortcut icon" href="http://localhost:5657/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="http://localhost:5657/a-simple-cep-processor-in-elixir/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Jonathan Harrington" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="A CEP Processor in Elixir" />
    <meta property="og:description" content="Just my thoughts, right or wrong" />
    <meta property="og:url" content="http://localhost:5657/a-simple-cep-processor-in-elixir/" />
    <meta property="og:image" content="http://localhost:5657/images/GenEventCEP.png" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="A CEP Processor in Elixir" />
    <meta name="twitter:description" content="Just my thoughts, right or wrong" />
    <meta name="twitter:url" content="http://localhost:5657/" />
    <meta name="twitter:image" content="http://localhost:5657/images/GenEventCEP.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Jonathan Harrington" />
    <meta name="twitter:site" content="@jonathanharring" />
    <meta name="twitter:creator" content="@jonathanharring" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="666" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Jonathan Harrington",
        "logo": "http://localhost:5657/"
    },
    "url": "http://localhost:5657/a-simple-cep-processor-in-elixir/",
    "image": {
        "@type": "ImageObject",
        "url": "http://localhost:5657/images/GenEventCEP.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:5657/a-simple-cep-processor-in-elixir/"
    },
    "description": "Just my thoughts, right or wrong"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="A CEP Processor in Elixir" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="http://localhost:5657/">Jonathan Harrington</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-tgh" href="https://github.com/prio" target="_blank" rel="noopener"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
            
            
                <a class="social-link social-link-tli" href="https://www.linkedin.com/in/jnharrington" target="_blank" rel="noopener"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn icon</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
                                    
            
                <a class="social-link social-link-tw" href="https://twitter.com/jonathanharring" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  post ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="26 May 2015">26 May 2015</time>
                    
                </section>
                <h1 class="post-full-title">A CEP Processor in Elixir</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/images/GenEventCEP.png)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p><a href="http://en.wikipedia.org/wiki/Complex_event_processing">CEP</a> is the term used to describe systems that process streams of events. In this post, we will use the the data structures created in a <a href="http://blog.jonharrington.org/simple-sliding-windows-in-elixir/">previous post</a> and a GenEvent server to create a simple CEP processor in Elixir.
<!--excerpt--></p>

<h3 id="introduction">Introduction</h3>

<p>The application we are creating is going to recieve stock quotes (“ticks”) for different stock symbols and output hourly average prices for each stock. Rather than connect to a live stock feed we will simulate a real time stock feed using random data. Our application design is as follows:</p>

<p><img src="/images/GenEventCEP.png" alt="Application Architecture" /></p>

<p>A GenEvent server receives events and passes them on to any process that has registered as a handler. Every registered handler receives every message (we can’‘t subscribe to a subset of topics like you can with message queues) so our application has two GenEvent servers, one that recieves input tick events from our “sources” and one that recieves output average events from our workers and passes them on to our “sinks”.</p>

<p>Our broker recieves ticks from the input GenEvent server. It then looks up the pid of the process registered for that tick symbol, if it finds it passes the event on to the worker, otherwise it passes it on to the worker factory.</p>

<p>Our worker factory recieves tick events and starts a new worker process to handle the event. Finally, our workers have a timed window data structure that they update every time they recieve an event. They then pass on the 60 minute average to the output GenEvent server. Ok, lets see some code.</p>

<p>(All the code can be found in the <a href="http://github.com/prio/excep">GitHub repo</a> but I recommended typing the code as you go and only referencing the repo if you get stuck.)</p>

<p><strong>Note</strong> You will need to add the code from a <a href="http://blog.jonharrington.org/simple-sliding-windows-in-elixir/">previous blog post</a> and <a href="https://github.com/bitwalker/timex">timex</a> to your dependencies.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir">  <span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
    <span class="p">[{</span><span class="ss">:window</span><span class="p">,</span> <span class="ss">github:</span> <span class="sd">"</span><span class="s2">prio/exwindow"</span><span class="p">},</span>
     <span class="p">{</span><span class="ss">:timex</span><span class="p">,</span> <span class="ss">github:</span> <span class="sd">"</span><span class="s2">bitwalker/timex"</span><span class="p">}]</span>
  <span class="k">end</span></code></pre></figure>

<h3 id="a-source">A Source</h3>

<p>Our source just generates random data to test our application so I won’‘t go into it in any detail. A real world source would read this data from a feed or a file (if you were doing backtesting for example). It gets passed the input GenEvent process on startup and after every “interval” period, it sends it a tick event.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Source</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>
  <span class="kn">use</span> <span class="no">Timex</span>

  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">{</span><span class="n">events</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">symbol</span><span class="p">})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">price</span> <span class="k">do</span>
    <span class="ss">:random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="ss">:erlang</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="ss">:random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="m">25</span><span class="p">)</span> <span class="o">+</span> <span class="m">100</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">start_timer</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="ss">:erlang</span><span class="o">.</span><span class="n">send_after</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span>
                       <span class="p">{</span><span class="ss">:tick</span><span class="p">,</span> <span class="p">{</span><span class="n">state</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">price</span><span class="p">()}})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">({</span><span class="n">events</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">symbol</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">%{</span><span class="ss">events:</span> <span class="n">events</span><span class="p">,</span> <span class="ss">symbol:</span> <span class="n">symbol</span><span class="p">,</span>
              <span class="ss">time:</span> <span class="n">trunc</span><span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">to_secs</span><span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">)),</span> <span class="ss">interval:</span> <span class="n">interval</span><span class="p">}</span>
    <span class="n">start_timer</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenEvent</span><span class="o">.</span><span class="n">sync_notify</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">events</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
    <span class="n">ups</span> <span class="o">=</span> <span class="p">%{</span> <span class="n">state</span> <span class="o">|</span> <span class="ss">time:</span> <span class="n">state</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">interval</span><span class="o">/</span><span class="m">1000</span><span class="p">}</span>
    <span class="n">start_timer</span><span class="p">(</span><span class="n">ups</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">ups</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3 id="the-factory">The Factory</h3>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">WorkerFactory</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>

  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_cast</span><span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:tick</span><span class="p">,</span> <span class="p">{</span><span class="n">symbol</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">}},</span> <span class="n">events</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="no">Worker</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
    <span class="no">Process</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">events</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3 id="the-broker">The Broker</h3>

<p>Our broker is the process that will recieve tick events and decide where to send them.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Broker</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenEvent</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">factory</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="n">event</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:tick</span><span class="p">,</span> <span class="p">{</span><span class="n">symbol</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">}},</span> <span class="n">factory</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">case</span> <span class="no">Process</span><span class="o">.</span><span class="n">whereis</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">nil</span> <span class="o">-&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
      <span class="n">pid</span> <span class="o">-&gt;</span> <span class="no">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">factory</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Our Broker recieves the factory process on start up and sends events to it if it can’‘t find the correct worker process.</p>

<h3 id="the-workers">The Workers</h3>

<p>Our worker code, will be fairly simple. One startup it creates a new timed window, every time it recieves a raw tick it adds it to the timed window and then sends the hourly average to the ouput GenEvent process.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Worker</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenServer</span>

  <span class="k">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="bp">__MODULE__</span><span class="p">,</span> <span class="p">{</span><span class="n">events</span><span class="p">,</span> <span class="n">symbol</span><span class="p">})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">({</span><span class="n">events</span><span class="p">,</span> <span class="n">symbol</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">window</span> <span class="o">=</span> <span class="no">Window</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="m">60</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%{</span><span class="ss">symbol:</span> <span class="n">symbol</span><span class="p">,</span> <span class="ss">events:</span> <span class="n">events</span><span class="p">,</span> <span class="ss">window:</span> <span class="n">window</span><span class="p">}}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_cast</span><span class="p">({</span><span class="ss">:tick</span><span class="p">,</span> <span class="p">{</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">}},</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
     <span class="n">w</span> <span class="o">=</span> <span class="no">Window</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="p">{</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">})</span>
     <span class="n">avg</span> <span class="o">=</span> <span class="no">Enum</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">/</span><span class="no">Enum</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
     <span class="no">GenEvent</span><span class="o">.</span><span class="n">sync_notify</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">events</span><span class="p">,</span> <span class="p">{</span><span class="ss">:avg</span><span class="p">,</span> <span class="p">{</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">avg</span><span class="p">}})</span>
     <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="p">%{</span> <span class="n">state</span> <span class="o">|</span> <span class="ss">window:</span> <span class="n">w</span><span class="p">}}</span>
   <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3 id="the-sink">The Sink</h3>

<p>Like the source module, our sink module is just a simple dummy useful for development. In real life you would probably use a sink to store the data to a database or a file (or both).</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Sink</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">GenEvent</span>
  <span class="kn">use</span> <span class="no">Timex</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">({</span><span class="ss">:avg</span><span class="p">,</span> <span class="p">{</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">value</span><span class="p">}},</span> <span class="n">factory</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="ss">:secs</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">DateFormat</span><span class="o">.</span><span class="n">format!</span><span class="p">(</span><span class="sd">"</span><span class="s2">{RFC1123}"</span><span class="p">)</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="sd">"</span><span class="si">#{</span><span class="n">date</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> average: </span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">factory</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">factory</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3 id="tieing-it-all-together">Tieing it all together</h3>

<p>Not that all our code is inplace we need to tied everything together and start our processes, we do this in our Application module.</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Cep</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Application</span>

  <span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">import</span> <span class="no">Supervisor</span><span class="o">.</span><span class="no">Spec</span><span class="p">,</span> <span class="ss">warn:</span> <span class="no">false</span>
    
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">input</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenEvent</span><span class="o">.</span><span class="n">start_link</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">output</span><span class="p">}</span> <span class="o">=</span> <span class="no">GenEvent</span><span class="o">.</span><span class="n">start_link</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">factory</span><span class="p">}</span> <span class="o">=</span> <span class="no">WorkerFactory</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="no">GenEvent</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="no">Broker</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>
    <span class="no">GenEvent</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="no">Sink</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>

    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
      <span class="n">worker</span><span class="p">(</span><span class="no">Source</span><span class="p">,</span> <span class="p">[</span><span class="n">input</span><span class="p">,</span> <span class="m">5000</span><span class="p">,</span> <span class="ss">:aapl</span><span class="p">],</span> <span class="ss">id:</span> <span class="sd">"</span><span class="s2">apple"</span><span class="p">),</span>
      <span class="n">worker</span><span class="p">(</span><span class="no">Source</span><span class="p">,</span> <span class="p">[</span><span class="n">input</span><span class="p">,</span> <span class="m">5000</span><span class="p">,</span> <span class="ss">:amzn</span><span class="p">],</span> <span class="ss">id:</span> <span class="sd">"</span><span class="s2">amazon"</span><span class="p">),</span>
      <span class="n">worker</span><span class="p">(</span><span class="no">Source</span><span class="p">,</span> <span class="p">[</span><span class="n">input</span><span class="p">,</span> <span class="m">5000</span><span class="p">,</span> <span class="ss">:goog</span><span class="p">],</span> <span class="ss">id:</span> <span class="sd">"</span><span class="s2">google"</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">,</span> <span class="ss">name:</span> <span class="no">Cep</span><span class="o">.</span><span class="no">Supervisor</span><span class="p">]</span>
    <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>    
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3 id="running-it">Running it</h3>

<p>Ok, with everything in place we should now be able to test our application. If you run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iex -S mix
</code></pre></div></div>

<p>and after 5 seconds you should start seeing averages being printed to the console. Play around with variables in the application module and see how hard you can make your CPU work :)</p>

<h2 id="conclusion">Conclusion</h2>

<p>We have seen how using GenEvent servers can decouple consumers/workers and producers. In the future this would allow us to easily add more “tick” consumers without having to modify the existing sources or sinks.</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'http://localhost:5657/a-simple-cep-processor-in-elixir/';
                            this.page.identifier = '/a-simple-cep-processor-in-elixir';
                            this.page.title = 'A CEP Processor in Elixir';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://magpietech.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>


<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'true';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/elixir-and-docker/">
                <div class="post-card-image" style="background-image: url(/images/docker.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/elixir-and-docker/">
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Elixir, Docker and PG2</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/simple-sliding-windows-in-elixir/">
                <div class="post-card-image" style="background-image: url(/images/Sized.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/simple-sliding-windows-in-elixir/">
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Simple Sliding Windows in Elixir</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="http://localhost:5657/">
            
                <img src="/assets/images/favicon.png" alt="Jonathan Harrington icon" />
            
            <span>Jonathan Harrington</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">A CEP Processor in Elixir</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=A+CEP+Processor+in+Elixir&amp;url=https://blog.jonharrington.org/a-simple-cep-processor-in-elixir/"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.jonharrington.org/a-simple-cep-processor-in-elixir/"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="http://localhost:5657/">Jonathan Harrington</a> &copy; 2020</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    <a href="https://github.com/prio" target="_blank" rel="noopener">Github</a>
                    <a href="https://www.linkedin.com/in/jnharrington" target="_blank" rel="noopener">Linkedin</a>
                    <a href="https://twitter.com/jonathanharring" target="_blank" rel="noopener">Twitter</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
